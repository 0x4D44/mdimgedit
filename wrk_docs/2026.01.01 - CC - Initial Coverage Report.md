# Code Coverage Report
**Date:** 2026-01-01
**Project:** mdimgedit

## Executive Summary
The project has excellent code coverage overall, with most core logic and CLI command dispatching well-tested. The integration tests successfully exercise the binary via `std::process::Command`, contributing significantly to the coverage.

However, there are specific pockets of missing coverage, particularly in:
1.  **EXIF Parsing:** The `read_exif` function's logic for extracting specific tags is untested because test images lack EXIF metadata.
2.  **Canvas Operations:** Some `Anchor` variants and `BlendMode::Overlay` are not covered.
3.  **CLI Arguments:** `ResizeFilter` conversion is partially tested.
4.  **Error Handling:** Specific error formatting and conversion paths (e.g., `IoError`, `ImageError` mapping) are missed.

## Detailed Analysis

### 1. Operations (`src/ops/`)

*   **`canvas.rs`**:
    *   `calculate_anchor_offset`: Only `TopLeft`, `Center`, and `BottomRight` are tested. Missing: `TopCenter`, `TopRight`, `CenterLeft`, `CenterRight`, `BottomLeft`, `BottomCenter`.
    *   `composite`: `BlendMode::Overlay` is implemented but never tested. `overlay_channel` function is unused/untested.
    *   `blend_pixels`: The `out_alpha < 0.001` branch is not hit.
    *   `pad`: The check for resulting zero dimensions is not hit.

*   **`exif.rs`**:
    *   `read_exif`: The loop extracting fields `for field in exif.fields()` is likely not entered or minimally exercised because test images generated by the `image` crate strip metadata.
    *   Consequently, the mapping logic for `camera_make`, `date_time`, `gps_*`, etc., is untested.
    *   `format_exif_text`: Many conditional branches (`if let Some(...)`) are not hit for the same reason.

*   **`resize.rs`**:
    *   `resize`: High coverage.
    *   `fit`: High coverage.

*   **`filter.rs`**:
    *   High coverage. `sharpen` and `blur` logic is well tested.

*   **`color.rs`**, **`flip.rs`**, **`crop.rs`**, **`adjust.rs`**:
    *   Very high coverage. Edge cases and invalid parameters are well handled.

### 2. CLI & Main (`src/cli/`, `src/main.rs`)

*   **`args.rs`**:
    *   `ResizeFilter::to_image_filter`: `Linear` and `Cubic` variants are not covered by tests.

*   **`output.rs`**:
    *   `print_success`: The text output branch when not quiet is partially missed.
    *   `to_json`: Error handling for JSON serialization failure (`unwrap_or_else`) is not hit (hard to trigger with simple structs).

*   **`main.rs`**:
    *   Command dispatch is well covered.
    *   `command_name`: Only hit for commands that triggered an error in `main`. Commands that always succeed in tests don't exercise their `command_name` mapping branch.
    *   `save_and_respond`: JSON output path is hit. Text output path is hit.

## Recommendations

1.  **Enhance Canvas Tests:** Add unit tests for all `Anchor` types and the `Overlay` blend mode.
2.  **Mock EXIF Data:** Since generating valid EXIF binaries is complex, focus on unit testing the *formatting* logic by manually constructing `ExifData` structs (already partially done). For `read_exif`, consider if a small static test file with EXIF can be added to fixtures, or accept the gap if valid EXIF generation is out of scope.
3.  **Complete Enum Testing:** Add tests for all `ResizeFilter` conversions.
4.  **Refine Error Tests:** Add specific unit tests for `ImgEditError` to cover the `IoError` and `ImageError` variants.

